{% extends "admin/base_site.html" %}
{% load i18n admin_urls import_export_tags static %}

{% block content %}
<style>
    /* Contenedor Fijo */
    .fixed-table-container {
        height: 65vh !important;
        overflow-y: auto !important;
        border: 2px solid #007bff; /* Borde Azul también para combinar */
        background: white;
        position: relative;
    }
    
    .fixed-table-container table {
        width: 100%;
        border-collapse: separate !important;
        border-spacing: 0;
    }

    /* --- CAMBIO: ENCABEZADO AZUL --- */
    .fixed-table-container thead th {
        position: sticky !important;
        top: 0 !important;
        background-color: #007bff !important; /* <--- AZUL INSTITUCIONAL */
        color: #fff !important;
        z-index: 500 !important;
        padding: 15px !important;
        border-bottom: 3px solid #ffc107 !important; /* Mantenemos la línea naranja */
    }

    .actions-box {
        background: #e9ecef; padding: 15px; border-bottom: 2px solid #007bff;
        display: flex; justify-content: space-between; align-items: center;
    }
</style>

{% if confirm_form %}
    <div class="col-12">
        <div class="card card-primary card-outline">
            <div class="card-header"><h3 class="card-title">Confirmar Importación</h3></div>
            <div class="card-body p-0">
                
                <form action="{% url opts|admin_urlname:'process_import' %}" method="POST">
                    {% csrf_token %}
                    <div class="actions-box">
                        <h5 class="m-0">Vista Previa: {{ result.rows|length }} registros</h5>
                        <div>
                            {{ confirm_form.as_p }}
                            <button type="submit" class="btn btn-success" name="confirm" value="Confirm">CONFIRMAR</button>
                        </div>
                    </div>
                </form>

                {% if result.rows %}
                    <div class="fixed-table-container">
                        <table class="table table-striped table-hover m-0">
                            <thead>
                                <tr>
                                    <th>Acción</th>
                                    <th>ID</th>
                                    {% for field in result.diff_headers %}<th>{{ field }}</th>{% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                            {% for row in result.rows %}
                                <tr>
                                    <td>{{ row.import_type|upper }}</td>
                                    <td>{{ row.object_id|default:"-" }}</td>
                                    {% for field in row.diff %}<td>{{ field }}</td>{% endfor %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% else %}
    <div class="col-12">
        <div class="card card-primary card-outline">
            <div class="card-header"><h3 class="card-title">Subir Archivo</h3></div>
            <div class="card-body text-center p-5">
                <form action="" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div style="border: 2px dashed #ccc; padding: 40px; background: #f9f9f9;">
                        <h3>Seleccione Excel</h3>
                        {{ form.as_p }}
                        <button type="submit" class="btn btn-primary btn-lg mt-3">Siguiente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}