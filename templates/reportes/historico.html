{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-chart-bar"></i> Dashboard Histórico de Horas Extras</h1>
            <p class="text-muted">Análisis de la carga de horas extra por Secretaría y tendencias mensuales.</p>
            <hr>
        </div>
    </div>
    
    <div class="row">
        
        <div class="col-lg-7 col-md-12">
            <div class="card card-primary card-outline">
                <div class="card-header">
                    <h3 class="card-title">Tendencia de Horas Totales (Últimos 6 Períodos)</h3>
                </div>
                <div class="card-body">
                    <canvas id="barChart" style="height:350px"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-5 col-md-12">
            <div class="card card-warning card-outline">
                <div class="card-header">
                    <h3 class="card-title">Distribución por Secretaría (Período: {{ periodo_actual_nombre }})</h3>
                </div>
                <div class="card-body">
                    <canvas id="pieChart" style="height:350px"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    // Variables inyectadas desde Django (usamos safe y JSON.parse para manejar strings de Python)
    const labelsBarra = {{ labels_barra|safe }};
    const datosBarra  = {{ datos_barra|safe }};
    const labelsTorta = {{ labels_torta|safe }};
    const datosTorta  = {{ datos_torta|safe }};

    
    // Función para generar colores dinámicos (para la torta)
    function dynamicColors(count) {
        let colors = [];
        const baseColors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997'];
        for(let i=0; i<count; i++) {
            colors.push(baseColors[i % baseColors.length]);
        }
        return colors;
    }

    // --- GRÁFICO DE BARRAS (Tendencia Mensual) ---
    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: labelsBarra,
            datasets: [{
                label: 'Total Horas',
                data: datosBarra,
                backgroundColor: dynamicColors(labelsBarra.length),
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Horas' } } },
            plugins: { legend: { display: false } }
        }
    });

    // --- GRÁFICO DE TORTA (Distribución por Secretaría) ---
    const ctxPie = document.getElementById('pieChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: labelsTorta,
            datasets: [{
                label: 'Distribución',
                data: datosTorta,
                backgroundColor: dynamicColors(labelsTorta.length), 
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: { 
                    callbacks: { 
                        label: function(context) { 
                            let label = context.label || ''; 
                            if (label) { label += ': '; } 
                            if (context.parsed !== null) { label += context.parsed.toFixed(1) + ' hs'; } 
                            return label; 
                        } 
                    } 
                }
            }
        }
    });
</script>
{% endblock %}